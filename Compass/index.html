<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Compass</title>
		<style>
			#pointer{
				z-index: 3;
				position: fixed !important;
			}
		</style>
	</head>
	<body>
		<canvas id="mainCanvas"></canvas>
		<canvas id="pointer" width="40" height="300"></canvas>

		<script src="js/jquery-2.0.3.min.js"></script>
		<script type="text/javascript" src="js/jQueryRotate.js"></script>
		<script>
			var sector = 0;
			var animDelay = 2000;
			var CANVAS_WIDTH = 480;		// Canvas width
			var CANVAS_HEIGHT = 480;	// Canvas height
			var FPS = 60;				// Frames per second
			var canvasCenterX = CANVAS_WIDTH / 2;
			var canvasCenterY = CANVAS_HEIGHT / 2;
			var mouse = {x:0,y:0};
			var sectors = 8;

			var box;
			var canvasElem;
			var c;
			var cw = 0;
			var ch = 0;

			var pointerElem;
			var p;
			
			$(function() {
				box = $("#mainCanvas")
				canvasElem = document.getElementById('mainCanvas');
				c = canvasElem.getContext("2d");
				pointerElem = document.getElementById('pointer');
				p = pointerElem.getContext("2d");


				var CANVAS_WIDTH = $(document).width();
				var CANVAS_HEIGHT = $(document).height();

				var boxCenter = [box.offset().left+box.width()/2, box.offset().top+box.height()/2];
				var mainAngle = Math.abs(Math.atan2(0 - boxCenter[0], - (0 - boxCenter[1]) )*(180/Math.PI));

				var mainCanvas = {
					draw: function() {

						c.fillStyle = "#58B8EB";
						c.fillStyle = "#F00";
						
						c.beginPath();
						c.fillStyle = "#0FDDF5";
						c.arc(cw/2, ch/2, 220, 0, 360, false);
						c.fill();
						c.beginPath();
						c.fillStyle = "#AFEEF9";
						c.arc(cw/2, ch/2, 200, 0, 360, false);
						c.fill();
					}
				};
				
				var pointer = {
					pw: 40,
					ph: pointerElem.height,
					update: function() {
						var angle = parseInt(Math.atan2(mouse.x- boxCenter[0], - (mouse.y- boxCenter[1]) )*(180/Math.PI));
						var fullAngle = angle;
						if(angle < 0) fullAngle = parseInt(180+(180+angle));

						if(fullAngle - $("#pointer").getRotateAngle() > 270) {
							$("#pointer").rotate({angle:angle,duration:animDelay});
						} else {
							$("#pointer").rotate({angle:fullAngle,duration:animDelay});
						}
						
						if(angle > -(mainAngle) && angle < 0) {
							sector = 2;

						} else if(angle > 0 && angle < mainAngle) {
							sector = 3;
						} else if(angle > mainAngle && angle < 90) {
							sector = 4;
						} else if(angle > 90 && angle < 90+(90-mainAngle)) {
							sector = 5;
						} else if(angle > 90+(90-mainAngle) && angle < 180) {
							sector = 6;
						} else if(angle > -90 && angle < -mainAngle) {
							sector = 1;
						} else if(angle > -90-(90-mainAngle) && angle < -90) {
							sector = 8;
						} else if(angle > -180 && angle < -90-(90-mainAngle)) {
							sector = 7;
						}
						//console.log("angle:"+parseInt(mainAngle)+": "+sector+"  "+angle+" = "+fullAngle+" ["+mouse.x+","+mouse.y+"]"+(fullAngle-$("#pointer").getRotateAngle()));
					},
					draw: function(){

						p.beginPath();
						p.moveTo(this.pw/2, 0);
						p.lineTo(0, this.ph/2);
						p.lineTo(this.pw/2, this.ph/2);
						p.lineTo(this.pw/2, 0);
						p.fillStyle = "#FF532B";
						p.fill();
						// 2
						p.beginPath();
						p.moveTo(this.pw/2, this.ph/2);
						p.lineTo(this.pw/2, this.ph);
						p.lineTo(0, this.ph/2);
						p.lineTo(this.pw/2, this.ph/2);
						p.fillStyle = "#DAE1EF";
						p.fill();
						// 3
						p.beginPath();
						p.moveTo(this.pw/2, 0);
						p.lineTo(this.pw/2, this.ph/2);
						p.lineTo(this.pw, this.ph/2);
						p.lineTo(this.pw/2, 0);
						p.fillStyle = "#DC052C";
						p.fill();
						// 4
						p.beginPath();
						p.moveTo(this.pw/2, this.ph/2);
						p.lineTo(this.pw/2, this.ph);
						p.lineTo(this.pw, this.ph/2);
						p.lineTo(this.pw/2, this.ph/2);
						p.fillStyle = "#91AEDC";
						p.fill();
					}
				};
				
				var onResize = function() {
					CANVAS_WIDTH = $(window).width();
					CANVAS_HEIGHT = $(window).height();
					cw = canvasElem.width = CANVAS_WIDTH;
					ch = canvasElem.height = CANVAS_HEIGHT;
					$("#mainCanvas").width(CANVAS_WIDTH);
					$("#mainCanvas").height(CANVAS_HEIGHT);
					$("#pointer").css("top", (CANVAS_HEIGHT/2)-$("#pointer").height()/2);
					$("#pointer").css("left", (CANVAS_WIDTH/2)-pointer.pw/2);
					//console.log(CANVAS_WIDTH+" "+CANVAS_HEIGHT);
					boxCenter = [box.offset().left+box.width()/2, box.offset().top+box.height()/2];
					mainAngle = Math.abs(Math.atan2(0 - boxCenter[0], - (0 - boxCenter[1]) )*(180/Math.PI));

					pointer.draw();
					mainCanvas.draw();
					
				};

				$(window).resize(function() {onResize();});

				$("#mainCanvas").mousemove(function(e) {
					mouse.x = e.pageX;
					mouse.y = e.pageY;
				});

				onResize();

				pointer.draw();
				mainCanvas.draw();
				setInterval(function() {
					pointer.update();
				}, 1000/FPS);
			});
		</script>
	</body>
</html>